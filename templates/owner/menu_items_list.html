{% extends "owner/base_owner.html" %}
{% block title %}Menu Items{% endblock %}

{% block content %}

<div class="mb-3">
  <h5 class="text-uppercase fw-semibold mb-0">Items</h5>
</div>

<div class="card border-0 shadow-sm mb-4">
  <div class="card-body">

    <!-- FILTERS (like screenshot) -->
    <div class="row gy-2 gx-3 align-items-center mb-2">

      <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
        <select class="form-select form-select-sm" id="filter-show">
          <option value="" selected>Show items</option>
          <option value="active">Active</option>
          <option value="archived">Archived</option>
        </select>
      </div>

      <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
        <select class="form-select form-select-sm" id="filter-category">
          <option value="" selected>Select category</option>
          {% for c in categories %}
            <option value="{{ c }}">{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6">
        <select class="form-select form-select-sm" id="filter-featured" disabled>
          <option selected>Select featured</option>
        </select>
      </div>

      <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
        <input class="form-control form-control-sm" id="filter-q" placeholder="Search item..." />
      </div>

      <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12 d-flex gap-2 justify-content-xl-end">
        <button class="btn btn-sm btn-primary px-4" id="btn-search" type="button">Search</button>
        <button class="btn btn-sm btn-outline-secondary px-4" id="btn-reset" type="button">Reset</button>

        <select class="form-select form-select-sm" id="filter-status" style="max-width: 160px;">
          <option value="" selected>Select Status</option>
          <option value="active">Active</option>
          <option value="archived">Archived</option>
        </select>
      </div>

    </div>

    <!-- ACTION BUTTONS ROW (like screenshot) -->
    <div class="d-flex flex-wrap gap-2 justify-content-end mb-3">
      <button class="btn btn-sm btn-outline-primary" type="button" disabled>
        <i class="bi bi-download me-1"></i> Sample file
      </button>
      <button class="btn btn-sm btn-primary" type="button" disabled>
        Import items
      </button>
      <button class="btn btn-sm btn-outline-primary" type="button" disabled>
        Export items
      </button>
      <button class="btn btn-sm btn-outline-primary" type="button" disabled>
        <i class="bi bi-plus-lg me-1"></i> Add new
      </button>
      <button class="btn btn-sm btn-outline-danger" type="button" disabled>
        <i class="bi bi-trash me-1"></i> Delete
      </button>
    </div>

    <!-- TABLE -->
    <div class="table-responsive">
      <table class="table align-middle table-hover mb-0">
        <thead class="small text-muted">
          <tr>
            <th style="width:40px;">
              <input type="checkbox" id="select-all">
            </th>
            <th style="min-width: 220px;">ITEM NAME</th>
            <th class="text-center" style="min-width: 120px;">S / V / A</th>

            <!-- Your model has only ONE price; we show it in all 3 columns for UI similarity -->
            <th class="text-center">POS PRICE</th>
            <th class="text-center">WEB PRICE</th>
            <th class="text-center">MOBILE PRICE</th>

            <th class="text-center">FEATURED</th>
            <th class="text-center">POS STATUS</th>
            <th class="text-center">MOBILE</th>
            <th class="text-center">MOBILE STATUS</th>
            <th class="text-center" style="width:110px;">ACTION</th>
          </tr>
        </thead>

        <tbody id="items-tbody">
          <tr>
            <td colspan="11" class="text-center text-muted py-4">Loading…</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-3">
      <div class="small text-muted" id="items-count">—</div>
      <button class="btn btn-sm btn-outline-secondary" id="btn-refresh" type="button">Refresh</button>
    </div>

  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  const API_URL = "/super-admin/owner/api/menu-items/";
  let ALL_ITEMS = [];

  function escapeHtml(s) {
    if (s === null || s === undefined) return "";
    return String(s)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function priceText(item) {
    if (item.price === null || item.price === undefined || item.price === "") return "—";
    return `${escapeHtml(item.currency || "INR")} ${escapeHtml(item.price)}`;
  }

  function badgeActive(text="Active") {
    return `<span class="badge bg-success-subtle text-success px-3">${text}</span>`;
  }
  function badgeInactive(text="Inactive") {
    return `<span class="badge bg-secondary-subtle text-muted px-3">${text}</span>`;
  }

  function svaBadges() {
    // UI mimic (your model doesn't store S/V/A). Later you can map to dietary tags from JSON/raw_data.
    return `
      <span class="badge bg-light text-muted border me-1">S</span>
      <span class="badge bg-light text-muted border me-1">V</span>
      <span class="badge bg-light text-muted border">A</span>
    `;
  }

  function renderRows(items) {
    const tbody = document.getElementById("items-tbody");
    const countEl = document.getElementById("items-count");
    countEl.textContent = `${items.length} item(s)`;

    if (!items.length) {
      tbody.innerHTML = `<tr><td colspan="11" class="text-center text-muted py-4">No items found.</td></tr>`;
      return;
    }

    tbody.innerHTML = items.map(item => {
      const name = escapeHtml(item.name);
      const category = item.category ? `<div class="small text-muted">${escapeHtml(item.category)}</div>` : "";
      const p = priceText(item);

      const posStatus = item.is_active ? badgeActive("Active") : badgeInactive("Archived");
      const mobileStatus = item.available ? badgeActive("Active") : badgeInactive("Inactive");

      return `
        <tr>
          <td><input type="checkbox" class="row-checkbox" value="${escapeHtml(item.id)}"></td>

          <td>
            <div class="fw-semibold">${name}</div>
            ${category}
          </td>

          <td class="text-center">${svaBadges()}</td>

          <td class="text-center">${p}</td>
          <td class="text-center">${p}</td>
          <td class="text-center">${p}</td>

          <td class="text-center">
            <input type="checkbox" disabled>
          </td>

          <td class="text-center">${posStatus}</td>
          <td class="text-center">${badgeActive("Active")}</td>
          <td class="text-center">${mobileStatus}</td>

          <td class="text-center">
            <a href="#" class="text-dark me-2" title="Edit"><i class="bi bi-pencil-square"></i></a>
            <a href="#" class="text-dark" title="Delete"><i class="bi bi-trash"></i></a>
          </td>
        </tr>
      `;
    }).join("");
  }

  function applyClientFilters() {
    const show = document.getElementById("filter-show").value; // active/archived/""
    const status = document.getElementById("filter-status").value; // active/archived/""
    const category = document.getElementById("filter-category").value;
    const q = document.getElementById("filter-q").value.trim().toLowerCase();

    let items = [...ALL_ITEMS];

    // show/status (both map to is_active)
    const activeFilter = (show || status);
    if (activeFilter === "active") items = items.filter(x => !!x.is_active);
    if (activeFilter === "archived") items = items.filter(x => !x.is_active);

    if (category) items = items.filter(x => (x.category || "") === category);

    if (q) {
      items = items.filter(x => {
        const name = (x.name || "").toLowerCase();
        const cat = (x.category || "").toLowerCase();
        const ext = (x.external_item_id || "").toLowerCase();
        return name.includes(q) || cat.includes(q) || ext.includes(q);
      });
    }

    renderRows(items);
  }

  async function fetchItems() {
    const tbody = document.getElementById("items-tbody");
    tbody.innerHTML = `<tr><td colspan="11" class="text-center text-muted py-4">Loading…</td></tr>`;

    try {
      const res = await fetch(API_URL, {
        headers: {
          "Accept": "application/json",
          ...RB_AUTH_HEADERS(),
        }
      });

      if (res.status === 401) {
        tbody.innerHTML = `<tr><td colspan="11" class="text-center text-danger py-4">
          Unauthorized (401). Please login again.
        </td></tr>`;
        return;
      }

      if (!res.ok) throw new Error("Failed to load: " + res.status);

      const data = await res.json();
      const results = data.results ?? data;
      ALL_ITEMS = Array.isArray(results) ? results : [];
      applyClientFilters();

    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="11" class="text-center text-danger py-4">
        ${escapeHtml(err.message)}
      </td></tr>`;
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    // select all
    const selectAll = document.getElementById("select-all");
    selectAll?.addEventListener("change", function () {
      document.querySelectorAll(".row-checkbox").forEach(cb => cb.checked = selectAll.checked);
    });

    document.getElementById("btn-search").addEventListener("click", applyClientFilters);
    document.getElementById("btn-reset").addEventListener("click", function () {
      document.getElementById("filter-show").value = "";
      document.getElementById("filter-category").value = "";
      document.getElementById("filter-status").value = "";
      document.getElementById("filter-q").value = "";
      applyClientFilters();
    });
    document.getElementById("btn-refresh").addEventListener("click", fetchItems);

    fetchItems();
  });
</script>
{% endblock %}

