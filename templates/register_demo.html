{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Register â€“ Restaurant Owner</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Restaurant Owner Registration</a>
    <div class="d-flex gap-2">
      <!-- ðŸ” Login button now goes to / -->
      <a href="/" class="btn btn-outline-light btn-sm">
        Login
      </a>
    </div>
  </div>
</nav>

<div class="container mt-4 mb-5">
  <div class="row justify-content-center">
    <div class="col-md-7 col-lg-6">

      <div class="text-center mb-3">
        <h3 class="fw-semibold mb-1">Create your account</h3>
        <p class="text-muted small mb-0">
          This will create a user and a linked restaurant for you.
        </p>
      </div>

      <div class="card shadow-sm border-0">
        <div class="card-body">
          <form id="register-form" method="post" novalidate>
            {% csrf_token %}

            <!-- USER SECTION -->
            <h6 class="text-uppercase text-muted small mb-2">Account Details</h6>
            <div class="mb-3">
              <label for="username" class="form-label">Username *</label>
              <input
                type="text"
                class="form-control"
                id="username"
                required
              >
            </div>

            <div class="mb-3">
              <label for="email" class="form-label">Email (optional)</label>
              <input
                type="email"
                class="form-control"
                id="email"
              >
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="password" class="form-label">Password *</label>
                <input
                  type="password"
                  class="form-control"
                  id="password"
                  required
                >
              </div>
              <div class="col-md-6 mb-3">
                <label for="password2" class="form-label">Confirm Password *</label>
                <input
                  type="password"
                  class="form-control"
                  id="password2"
                  required
                >
              </div>
            </div>

            <!-- RESTAURANT SECTION -->
            <hr class="my-3">
            <h6 class="text-uppercase text-muted small mb-2">Restaurant Details</h6>

            <div class="mb-3">
              <label for="restaurant_name" class="form-label">Restaurant Name *</label>
              <input
                type="text"
                class="form-control"
                id="restaurant_name"
                required
              >
            </div>

            <div class="mb-3">
              <label for="restaurant_phone" class="form-label">Phone *</label>
              <input
                type="text"
                class="form-control"
                id="restaurant_phone"
                required
              >
            </div>

            <div class="mb-3">
              <label for="restaurant_address" class="form-label">Address (optional)</label>
              <textarea
                class="form-control"
                id="restaurant_address"
                rows="2"
              ></textarea>
            </div>

            <button type="submit" class="btn btn-primary w-100" id="register-btn">
              Create Account
            </button>

            <div class="mt-2">
              <span id="register-status" class="small"></span>
            </div>
          </form>
        </div>
      </div>

      <p class="text-muted small mt-3 mb-0">
        Already have an account?
        <!-- ðŸ” Login link now goes to / -->
        <a href="/">Login here</a>.
      </p>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const REGISTER_API_URL = "/api/accounts/register/";
  const LOGIN_API_URL = "/api/accounts/login/";
  // â¬‡ï¸ After registration, go to login page
  const DASHBOARD_URL = "/";

  const ACCESS_TOKEN_KEY = "rb_access_token";
  const REFRESH_TOKEN_KEY = "rb_refresh_token";
  const USER_KEY = "rb_user";

  const form = document.getElementById("register-form");
  const statusEl = document.getElementById("register-status");
  const registerBtn = document.getElementById("register-btn");

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.split("=")[1]);
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  async function loginAfterRegister(username, password) {
    try {
      const res = await fetch(LOGIN_API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "X-CSRFToken": csrftoken,
        },
        credentials: "same-origin",
        body: JSON.stringify({ username, password }),
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        data = { raw: text };
      }

      if (!res.ok) {
        console.warn("Auto-login failed after registration", data);
        statusEl.textContent = "Registered, but login failed. Please login manually.";
        statusEl.classList.add("text-warning");
        return;
      }

      const access = data.access;
      const refresh = data.refresh;
      const user = data.user;

      localStorage.setItem(ACCESS_TOKEN_KEY, access);
      localStorage.setItem(REFRESH_TOKEN_KEY, refresh);
      localStorage.setItem(USER_KEY, JSON.stringify(user));

      // â¬‡ï¸ Message updated to login page
      statusEl.textContent = "Registration successful âœ… Redirecting to login page...";
      statusEl.classList.remove("text-danger");
      statusEl.classList.add("text-success");

      setTimeout(() => {
        window.location.href = DASHBOARD_URL;
      }, 800);
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Registered, but automatic login failed. Please login manually.";
      statusEl.classList.add("text-warning");
    }
  }

  form.addEventListener("submit", async function (event) {
    event.preventDefault();

    statusEl.textContent = "";
    statusEl.className = "small";

    const username = document.getElementById("username").value.trim();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const password2 = document.getElementById("password2").value;

    const restaurant_name = document.getElementById("restaurant_name").value.trim();
    const restaurant_phone = document.getElementById("restaurant_phone").value.trim();
    const restaurant_address = document.getElementById("restaurant_address").value.trim();

    if (!username || !password || !password2 || !restaurant_name || !restaurant_phone) {
      statusEl.textContent = "Please fill all required (*) fields.";
      statusEl.classList.add("text-danger");
      return;
    }

    if (password !== password2) {
      statusEl.textContent = "Passwords do not match.";
      statusEl.classList.add("text-danger");
      return;
    }

    registerBtn.disabled = true;
    statusEl.textContent = "Creating your account...";
    statusEl.classList.remove("text-danger", "text-success");

    try {
      const payload = {
        username: username,
        email: email || null,
        password: password,
        restaurant_name: restaurant_name,
        restaurant_phone: restaurant_phone,
        restaurant_address: restaurant_address,
      };

      const res = await fetch(REGISTER_API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "X-CSRFToken": csrftoken,
        },
        credentials: "same-origin",
        body: JSON.stringify(payload),
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch (e) {
        data = { raw: text };
      }

      if (!res.ok) {
        console.error("Register error", data);
        let msg = "Error creating account.";
        if (data && data.username) {
          msg = data.username.join(" ");
        } else if (data && data.email) {
          msg = data.email.join(" ");
        }
        statusEl.textContent = msg;
        statusEl.classList.add("text-danger");
        return;
      }

      // Success â†’ auto login using same username/password
      await loginAfterRegister(username, password);

    } catch (err) {
      console.error(err);
      statusEl.textContent = "Network error while creating account.";
      statusEl.classList.add("text-danger");
    } finally {
      registerBtn.disabled = false;
    }
  });
</script>

</body>
</html>
