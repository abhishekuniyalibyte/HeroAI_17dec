{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Menu Add â€“ API Demo</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <style>
    body {
      background: #f3f4f6;
    }

    .navbar {
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.25);
    }

    .page-header {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .page-header h4 {
      margin-bottom: 0;
    }

    .page-header p {
      margin: 0;
      font-size: 0.875rem;
      color: #6b7280;
    }

    .table thead th {
      white-space: nowrap;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .badge-yes {
      background-color: #16a34a;
    }

    .badge-no {
      background-color: #dc2626;
    }

    .small-muted {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .table-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }

    .table-toolbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .table-toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .search-input {
      max-width: 260px;
    }

    .item-count-badge {
      font-size: 0.75rem;
    }
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Restaurant Menu â€“ API Demo</a>

    <div class="d-flex align-items-center gap-2 ms-auto">
      <!-- ðŸ”¹ New Dashboard button -->
      <a
        href="/api/chatbot/dashboard/widget/show/"
        class="btn btn-outline-light btn-sm"
      >
        Dashboard
      </a>
      <span class="navbar-text small" id="nav-user-label"></span>
    </div>
  </div>
</nav>

<div class="container mb-5">

  <!-- Info / login reminder -->
  <div id="login-warning" class="alert alert-warning d-none">
    You are not logged in. Please
    <a href="/api/accounts/login-demo/" class="alert-link">go to the login page</a>
    and sign in first.
  </div>

  <!-- HEADER -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="page-header">
        <h4 class="mb-1">Menu Items (for logged-in restaurant owner)</h4>
        <p>View, search and add items to your live menu. This uses the same API that the chatbot relies on.</p>
      </div>
    </div>
  </div>

  <!-- ROW: table + refresh button + search -->
  <div class="row mb-4">
    <div class="col-12 d-flex flex-column gap-2">

      <div class="table-toolbar">
        <div class="table-toolbar-left">
          <h5 class="mb-0">Existing Items</h5>
          <span id="item-count" class="badge bg-secondary item-count-badge d-none"></span>
        </div>

        <div class="table-toolbar-right">
          <input
            type="text"
            id="menu-search"
            class="form-control form-control-sm search-input"
            placeholder="Search by name or category..."
          >
          <button class="btn btn-sm btn-outline-primary" id="refresh-menu-btn">
            Refresh
          </button>
        </div>
      </div>

      <div class="table-responsive mt-2">
        <table class="table table-sm table-striped align-middle">
          <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Category</th>
            <th>Price</th>
            <th>Currency</th>
            <th>Available</th>
            <th>Ingredients</th>
            <th>Updated</th>
          </tr>
          </thead>
          <tbody id="menu-table-body">
          <tr>
            <td colspan="8" class="text-center text-muted">
              Loading...
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ROW: create form -->
  <div class="row">
    <div class="col-12 col-lg-8">
      <div class="card">
        <div class="card-header">
          Create New Menu Item
        </div>
        <div class="card-body">
          <form id="menu-create-form" class="row g-3">
            <div class="col-md-6">
              <label for="menu-name" class="form-label">Name *</label>
              <input type="text" class="form-control" id="menu-name" required>
            </div>

            <div class="col-md-6">
              <label for="menu-category" class="form-label">Category</label>
              <input type="text" class="form-control" id="menu-category" placeholder="e.g. Main Course">
            </div>

            <div class="col-md-4">
              <label for="menu-price" class="form-label">Price *</label>
              <input type="number" step="0.01" class="form-control" id="menu-price" required>
            </div>

            <div class="col-md-4">
              <label for="menu-currency" class="form-label">Currency</label>
              <select class="form-select" id="menu-currency">
                <option value="INR" selected>INR</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label d-block">Flags</label>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="menu-available" checked>
                <label class="form-check-label" for="menu-available">Available</label>
              </div>
            </div>

            <div class="col-12">
              <label for="menu-description" class="form-label">Description</label>
              <textarea class="form-control" id="menu-description" rows="2"></textarea>
              <div class="small-muted mt-1">
                Optional. This is what the chatbot may use when describing the item.
              </div>
            </div>

            <div class="col-12">
              <label for="menu-ingredients" class="form-label">
                Ingredients (comma separated)
              </label>
              <input
                type="text"
                class="form-control"
                id="menu-ingredients"
                placeholder="e.g. paneer, tomato, onion"
              >
              <div class="small-muted mt-1">
                Stored as a JSON list internally (e.g. <code>["paneer", "tomato", "onion"]</code>).
              </div>
            </div>

            <div class="col-12">
              <button type="submit" class="btn btn-primary" id="menu-submit-btn">
                Create Menu Item
              </button>
              <span id="menu-form-status" class="ms-2 small"></span>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- small note card -->
    <div class="col-12 col-lg-4 mt-3 mt-lg-0">
      <div class="card">
        <div class="card-body">
          <h6>Notes</h6>
          <ul class="small mb-0">
            <li>Login first at <code>/api/accounts/login-demo/</code>.</li>
            <li>This page uses the JWT stored in <code>localStorage</code>.</li>
            <li>API uses <code>MenuItemViewSet</code> with <code>IsAuthenticated</code>.</li>
            <li>Items created here appear in your chatbot responses (after embeddings update).</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // === CONFIG: must match your backend routes ===
  const MENU_API_URL = "/api/menu/menu-items/";

  const ACCESS_TOKEN_KEY = "rb_access_token";
  const REFRESH_TOKEN_KEY = "rb_refresh_token";
  const USER_KEY = "rb_user";

  // CSRF helper (needed only if also using SessionAuthentication; harmless otherwise)
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  // === AUTH HELPERS ===
  function getAccessToken() {
    return localStorage.getItem(ACCESS_TOKEN_KEY);
  }

  function getUserFromStorage() {
    const raw = localStorage.getItem(USER_KEY);
    if (!raw) return null;
    try {
      return JSON.parse(raw);
    } catch (e) {
      return null;
    }
  }

  function getAuthHeaders(extra = {}) {
    const token = getAccessToken();
    const headers = {
      "Accept": "application/json",
      ...extra,
    };
    if (token) {
      headers["Authorization"] = "Bearer " + token;
    }
    return headers;
  }

  function updateNavUserLabel() {
    const label = document.getElementById("nav-user-label");
    const user = getUserFromStorage();
    const token = getAccessToken();
    if (token && user) {
      const name = user.username || user.email || "user";
      label.textContent = "Logged in as " + name;
    } else {
      label.textContent = "Not logged in";
    }
  }

  function showLoginWarningIfNeeded() {
    const warning = document.getElementById("login-warning");
    if (!getAccessToken()) {
      warning.classList.remove("d-none");
    } else {
      warning.classList.add("d-none");
    }
  }

  // === MENU DATA CACHE (for search) ===
  let cachedMenuItems = [];

  const tbody = document.getElementById("menu-table-body");
  const itemCountEl = document.getElementById("item-count");
  const searchInput = document.getElementById("menu-search");

  // --- Render table from given items array ---
  function renderMenuTable(items) {
    if (!items || !items.length) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No menu items found.</td></tr>';
      itemCountEl.classList.add("d-none");
      return;
    }

    tbody.innerHTML = "";
    items.forEach((item) => {
      const price = item.price ?? "";
      const currency = item.currency ?? "INR";
      const category = item.category ?? "";
      const availableLabel = item.available ? "Yes" : "No";
      const availableClass = item.available ? "badge-yes" : "badge-no";
      const ingredients = Array.isArray(item.ingredients)
        ? item.ingredients.join(", ")
        : (item.ingredients || "");
      const updated = item.updated_at ? new Date(item.updated_at).toLocaleString() : "";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.id}</td>
        <td>${item.name}</td>
        <td>${category}</td>
        <td>${price}</td>
        <td>${currency}</td>
        <td>
          <span class="badge ${availableClass}">${availableLabel}</span>
        </td>
        <td>${ingredients}</td>
        <td>${updated}</td>
      `;
      tbody.appendChild(tr);
    });

    itemCountEl.textContent = items.length + " item" + (items.length !== 1 ? "s" : "");
    itemCountEl.classList.remove("d-none");
  }

  // --- Filter based on search bar ---
  function applySearchFilter() {
    const q = (searchInput.value || "").toLowerCase().trim();
    if (!q) {
      renderMenuTable(cachedMenuItems);
      return;
    }

    const filtered = cachedMenuItems.filter((item) => {
      const name = (item.name || "").toLowerCase();
      const category = (item.category || "").toLowerCase();
      return name.includes(q) || category.includes(q);
    });

    renderMenuTable(filtered);
  }

  // === MENU: list items ===
  async function loadMenu() {
    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Loading...</td></tr>';

    if (!getAccessToken()) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">No token found. Please login first.</td></tr>';
      showLoginWarningIfNeeded();
      itemCountEl.classList.add("d-none");
      return;
    }

    try {
      const res = await fetch(MENU_API_URL, {
        method: "GET",
        headers: getAuthHeaders(),
      });

      if (res.status === 401) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Unauthorized (401). Token invalid or expired. Please login again.</td></tr>';
        showLoginWarningIfNeeded();
        itemCountEl.classList.add("d-none");
        return;
      }

      if (!res.ok) {
        throw new Error("Failed to load menu: " + res.status);
      }

      const data = await res.json();
      const items = Array.isArray(data) ? data : (data.results || []);

      cachedMenuItems = items;
      if (!items.length) {
        renderMenuTable([]);
        return;
      }

      renderMenuTable(items);
    } catch (err) {
      console.error(err);
      tbody.innerHTML = '<tr><td colspan="8" class="text-danger text-center">Error loading menu</td></tr>';
      itemCountEl.classList.add("d-none");
    }
  }

  // === MENU: create item ===
  async function handleCreateMenuItem(event) {
    event.preventDefault();

    const statusEl = document.getElementById("menu-form-status");
    const submitBtn = document.getElementById("menu-submit-btn");

    statusEl.textContent = "";
    statusEl.className = "ms-2 small";

    if (!getAccessToken()) {
      statusEl.textContent = "Please login first.";
      statusEl.classList.add("text-danger");
      showLoginWarningIfNeeded();
      return;
    }

    const name = document.getElementById("menu-name").value.trim();
    const category = document.getElementById("menu-category").value.trim();
    const price = document.getElementById("menu-price").value;
    const currency = document.getElementById("menu-currency").value;
    const description = document.getElementById("menu-description").value.trim();
    const ingredientsRaw = document.getElementById("menu-ingredients").value.trim();
    const available = document.getElementById("menu-available").checked;

    if (!name || !price) {
      statusEl.textContent = "Name and price are required.";
      statusEl.classList.add("text-danger");
      return;
    }

    // convert "paneer, tomato, onion" â†’ ["paneer", "tomato", "onion"]
    let ingredients = [];
    if (ingredientsRaw) {
      ingredients = ingredientsRaw
        .split(",")
        .map((s) => s.trim())
        .filter((s) => s.length > 0);
    }

    const payload = {
      name: name,
      description: description,
      price: price,
      available: available,
      category: category,
      currency: currency,
      ingredients: ingredients,   // JSON list
    };

    try {
      submitBtn.disabled = true;
      const originalText = submitBtn.textContent;
      submitBtn.textContent = "Saving...";

      const res = await fetch(MENU_API_URL, {
        method: "POST",
        headers: getAuthHeaders({
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
        }),
        body: JSON.stringify(payload),
      });

      if (res.status === 401) {
        statusEl.textContent = "Unauthorized (401). Token invalid or expired. Please login again.";
        statusEl.classList.add("text-danger");
        showLoginWarningIfNeeded();
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        return;
      }

      if (!res.ok) {
        const text = await res.text();
        console.error("Create failed:", res.status, text);
        statusEl.textContent = "Error creating item";
        statusEl.classList.add("text-danger");
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
        return;
      }

      statusEl.textContent = "Created successfully âœ…";
      statusEl.classList.add("text-success");

      document.getElementById("menu-create-form").reset();
      document.getElementById("menu-available").checked = true;

      await loadMenu(); // refresh table

      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Error creating item";
      statusEl.classList.add("text-danger");
      const submitBtn = document.getElementById("menu-submit-btn");
      submitBtn.disabled = false;
      submitBtn.textContent = "Create Menu Item";
    }
  }

  // === Init ===
  document.addEventListener("DOMContentLoaded", () => {
    updateNavUserLabel();
    showLoginWarningIfNeeded();

    document
      .getElementById("refresh-menu-btn")
      .addEventListener("click", loadMenu);

    document
      .getElementById("menu-create-form")
      .addEventListener("submit", handleCreateMenuItem);

    searchInput.addEventListener("input", applySearchFilter);

    // Auto-load if already have token
    if (getAccessToken()) {
      loadMenu();
    } else {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">No token found. Please login first.</td></tr>';
      itemCountEl.classList.add("d-none");
    }
  });
</script>

</body>
</html>

