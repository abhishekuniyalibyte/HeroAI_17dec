{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login â€“ Restaurant Admin</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <style>
    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    /* Full page split layout */
    .login-wrapper {
      min-height: 100vh;
      display: flex;
      flex-direction: row;
      background-color: #f3f4f6;
    }

    /* Left side â€“ form */
    .login-left {
      width: 100%;
      max-width: 480px;        /* fixed-ish width like your screenshot */
      padding: 2.5rem 2rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: #f9fafb;
    }

    .login-card {
      width: 100%;
      max-width: 360px;
      padding: 2rem 2.2rem;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.16);
      border: 1px solid #e5e7eb;
    }

    .brand-title {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: #2563eb;
    }

    .brand-subtitle {
      font-size: 0.9rem;
      color: #6b7280;
    }

    /* Right side â€“ big image */
    .login-right {
      flex: 1;
      background-image: url("{% static 'images/pexels-reneterp-2544829.jpg' %}");
      background-size: cover;
      /* 50% = center, 70% = thoda right shift, left side kam visible */
      background-position: 70% center;
      background-repeat: no-repeat;
    }

    /* Small screens: hide image, center card */
    @media (max-width: 768px) {
      .login-wrapper {
        flex-direction: column;
      }
      .login-right {
        display: none;
      }
      .login-left {
        max-width: 100%;
        padding: 2rem 1.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="login-wrapper">
    <!-- LEFT: Form -->
    <div class="login-left">
      <div class="login-card">

        <!-- Logo / Brand + Sign in text -->
        <div class="mb-3 text-center">
          <div class="brand-title mb-1">RESTAURANT BOT</div>
          <h5 class="mb-1">Sign In</h5>
          <p class="brand-subtitle mb-0">
            Enter your credentials to access the owner panel.
          </p>
        </div>

        <!-- Logged-in banner (based on localStorage) -->
        <div id="welcome-user-banner"
             class="alert alert-success py-2 px-3 small d-none mb-3"></div>

        <!-- Form -->
        <form id="login-form" method="post" novalidate>
          {% csrf_token %}

          <div class="mb-3">
            <label for="username" class="form-label">Username</label>
            <input
              type="text"
              class="form-control"
              id="username"
              placeholder="Enter your username"
              required
            >
          </div>

          <div class="mb-2">
            <label for="password" class="form-label">Password</label>
            <input
              type="password"
              class="form-control"
              id="password"
              placeholder="Enter your password"
              required
            >
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="show-password">
            <label class="form-check-label small" for="show-password">
              Show password
            </label>
          </div>

          <button type="submit" class="btn btn-primary w-100" id="login-btn">
            Sign In
          </button>

          <div class="mt-2">
            <span id="login-status" class="small"></span>
          </div>
        </form>

        <!-- Register button -->
        <div class="mt-3">
          <a
            href="http://127.0.0.1:8000/api/accounts/register-demo/"
            class="btn btn-outline-secondary w-100 btn-sm"
          >
            Register as Restaurant Owner
          </a>
        </div>

      </div>
    </div>

    <!-- RIGHT: Big Background Image -->
    <div class="login-right"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ðŸ”§ API URL for login
    const LOGIN_API_URL = "/api/accounts/login/";
    // ðŸ”§ Where to go after login (Widget Settings Page)
    const DASHBOARD_URL = "{% url 'widget-settings-page' %}";

    const form = document.getElementById("login-form");
    const loginBtn = document.getElementById("login-btn");
    const statusEl = document.getElementById("login-status");
    const welcomeBanner = document.getElementById("welcome-user-banner");

    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const showPasswordCheckbox = document.getElementById("show-password");

    // Get CSRF cookie from Django
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    const csrftoken = getCookie("csrftoken");
    console.log("CSRFTOKEN from cookie:", csrftoken);

    // Toggle password visibility
    showPasswordCheckbox.addEventListener("change", function () {
      passwordInput.type = this.checked ? "text" : "password";
    });

    function refreshWelcomeFromStorage() {
      const userJson = localStorage.getItem("rb_user");
      const access = localStorage.getItem("rb_access_token");

      if (!userJson || !access) {
        welcomeBanner.classList.add("d-none");
        welcomeBanner.textContent = "";
        return;
      }

      try {
        const user = JSON.parse(userJson);
        const name = user.username || user.email || "user";
        welcomeBanner.textContent = `Currently logged in (from storage): ${name}`;
        welcomeBanner.classList.remove("d-none");
      } catch (e) {
        welcomeBanner.classList.add("d-none");
        welcomeBanner.textContent = "";
      }
    }

    form.addEventListener("submit", async function (event) {
      event.preventDefault();

      statusEl.textContent = "";
      statusEl.className = "small";

      const username = usernameInput.value.trim();
      const password = passwordInput.value;

      if (!username || !password) {
        statusEl.textContent = "Username and password are required.";
        statusEl.classList.add("text-danger");
        return;
      }

      loginBtn.disabled = true;
      statusEl.textContent = "Logging in...";
      statusEl.classList.remove("text-danger", "text-success");

      try {
        const res = await fetch(LOGIN_API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json",
            "X-CSRFToken": csrftoken,
          },
          credentials: "same-origin",
          body: JSON.stringify({ username, password }),
        });

        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          data = { raw: text };
        }

        if (!res.ok) {
          statusEl.textContent = data.detail || "Invalid credentials.";
          statusEl.classList.add("text-danger");
          localStorage.removeItem("rb_access_token");
          localStorage.removeItem("rb_refresh_token");
          localStorage.removeItem("rb_user");
          refreshWelcomeFromStorage();
          return;
        }

        const access = data.access;
        const refresh = data.refresh;
        const user = data.user;

        localStorage.setItem("rb_access_token", access);
        localStorage.setItem("rb_refresh_token", refresh);
        localStorage.setItem("rb_user", JSON.stringify(user));

        statusEl.textContent = "Login successful âœ… Redirecting...";
        statusEl.classList.add("text-success");

        refreshWelcomeFromStorage();

        setTimeout(() => {
          window.location.href = DASHBOARD_URL;
        }, 800);

      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error calling login API.";
        statusEl.classList.add("text-danger");
      } finally {
        loginBtn.disabled = false;
      }
    });

    refreshWelcomeFromStorage();
  </script>
</body>
</html>
